---
description: Windows 會快取從磁片讀取並寫入磁片的檔案資料。
ms.assetid: 0865c741-63e3-4246-ba69-801b02153e4a
title: 檔案快取
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 1a14fb668af16cfb8a4e42b59b25b73ecefbb7cb
ms.sourcegitcommit: 831e8f3db78ab820e1710cede244553c70e50500
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/08/2021
ms.locfileid: "103852132"
---
# <a name="file-caching"></a>檔案快取

根據預設，Windows 會快取從磁碟讀取與寫入到磁碟的檔案資料。 這表示讀取作業會從系統記憶體（稱為系統檔案快取）中的區域讀取檔案資料，而不是從實體磁片讀取檔案資料。 同樣地，寫入作業會將檔案資料寫入到系統檔案快取而非寫入到磁碟，而且此類型的快取稱為回寫式快取。 快取是以個別檔案物件為單位來管理。

快取會在快取 *管理員* 的方向下進行，它會在 Windows 執行時持續運作。 系統檔案快取中的檔案資料會以作業系統所決定的間隔寫入磁片，而該檔案資料先前使用的記憶體會 *釋出，* 這稱為清除快取。 延遲將資料寫入至檔案，並將其保存在快取中，直到快取排清為止的原則稱為「延遲寫入」，且快取管理員會在確定時間間隔觸發此原則。 檔案資料區塊排清的時間部分是以資料儲存在快取中的時間長度以及該資料自上次在讀取作業中存取之後的時間長度為基礎。 這可確保頻繁讀取的檔案資料將可儘可能地維持在系統檔案快取中供存取。

下圖說明此檔案資料快取程式。

![檔案資料快取進程](images/fig3.png)

如上圖中的實心箭號所示，當快取管理員在檔案讀取作業期間第一次要求時，會將 256 KB 的資料區域讀入系統位址空間中的 256 KB 快取「位置」。 使用者模式處理序接著會將此位置資料複製到其自己的位址空間。 當處理序完成其資料存取時，它會將修改的資料寫回系統快取中的相同位置，如處理序位址空間與系統快取之間的點箭號所示。 當快取管理員判定在一段時間內不再需要資料時，它會將改變的資料寫回磁片上的檔案，如系統快取和磁片之間的點箭號所示。

檔案資料快取所提供的 i/o 效能改善數量，取決於所讀取或寫入的檔案資料區塊大小。 讀取和寫入大量的檔案資料時，很可能需要磁片讀取和寫入才能完成 i/o 作業。 I/o 效能會變得越來越大，因為這種類型的 i/o 作業也會發生。

在這些情況下，可以關閉快取。 這是在開啟檔案時完成的，方法是將 **檔案 \_ 旗標 \_ 無 \_ 緩衝** 處理傳遞為 [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea)的 *dwFlagsAndAttributes* 參數值。 停用快取時，所有的讀取和寫入作業都會直接存取實體磁片。 但是，檔案中繼資料仍可能會被快取。 若要將中繼資料排清到磁片，請使用 [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) 函數。

發生排清的頻率是在系統效能與系統可靠性之間取得平衡的重要考慮。 如果系統過於頻繁地排清快取，則排清的大型寫入作業數目將會大幅降低系統效能。 如果系統的清除頻率過高，則可能是因為系統記憶體會被快取耗盡，或是突然的系統故障 (例如，電腦的電源中斷) 將在排清之前發生。 在後者的實例中，快取的資料將會遺失。

為了確保發生適當的排清量，快取管理員會每秒產生一個處理常式，稱為「延遲寫入器」。 延遲寫入器進程會將最近未排清的頁面排入佇列，以寫入磁片。 它會持續重新評估為了達到最佳系統效能而排清的資料量，如果需要寫入更多資料，就會將更多的資料排入佇列。 延遲寫入器不會清除暫存檔案，因為這是由應用程式或系統所刪除。

某些應用程式（例如病毒檢查軟體）需要將其寫入作業立即排清到磁片;Windows 透過寫入快取來提供這種功能。 程式會藉由將檔案 **\_ 旗標 \_ 寫入 \_ 至** [**CreateFile**](/windows/desktop/api/FileAPI/nf-fileapi-createfilea)的呼叫，藉以啟用特定 i/o 作業的寫入快取。 啟用寫入快取之後，資料仍會寫入快取中，但是快取管理員會將資料立即寫入磁片，而不是使用延遲寫入器產生延遲。 進程也可以藉由呼叫 [**FlushFileBuffers**](/windows/desktop/api/FileAPI/nf-fileapi-flushfilebuffers) 函式來強制清除其開啟的檔案。

檔案系統中繼資料一律會進行快取。 因此，若要將任何中繼資料變更儲存至磁片，必須 **\_ 透過檔案旗標 \_ 寫入 \_** 來清除或開啟檔案。

 

 



