---
title: 搭配主要安裝程式使用重新開機管理員
description: 下列程式說明如何使用重新開機管理員來關閉和重新開機應用程式和服務。 使用重新開機管理員搭配單一安裝程式時，此安裝程式也是控制使用者介面的主要安裝程式。
ms.assetid: 8d2b4129-c595-4b11-9771-6dc953f4db40
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 38956ee8d04bc377809e93579080d9b767c3da3a
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "103932040"
---
# <a name="using-restart-manager-with-a-primary-installer"></a><span data-ttu-id="8ffb5-104">搭配主要安裝程式使用重新開機管理員</span><span class="sxs-lookup"><span data-stu-id="8ffb5-104">Using Restart Manager with a Primary Installer</span></span>

<span data-ttu-id="8ffb5-105">下列程式說明如何使用重新開機管理員來關閉和重新開機應用程式和服務。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-105">The following procedure describes how to use the Restart Manager to shutdown and restart applications and services.</span></span> <span data-ttu-id="8ffb5-106">使用重新開機管理員搭配單一安裝程式時，此安裝程式也是控制使用者介面的主要安裝程式。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-106">When using the Restart Manager with a single installer, this installer is also the primary installer that controls the user interface.</span></span>

<span data-ttu-id="8ffb5-107">**搭配主要安裝程式使用重新開機管理員**</span><span class="sxs-lookup"><span data-stu-id="8ffb5-107">**To use the Restart Manager with a primary installer**</span></span>

1.  <span data-ttu-id="8ffb5-108">安裝程式會呼叫 [**RmStartSession**](/windows/desktop/api/RestartManager/nf-restartmanager-rmstartsession) 函式來啟動重新開機管理員會話，並取得會話控制碼和金鑰。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-108">The installer calls the [**RmStartSession**](/windows/desktop/api/RestartManager/nf-restartmanager-rmstartsession) function to start the Restart Manager session and obtain a session handle and key.</span></span>
2.  <span data-ttu-id="8ffb5-109">安裝程式會呼叫 [**RmRegisterResources**](/windows/desktop/api/RestartManager/nf-restartmanager-rmregisterresources) 函數來註冊資源。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-109">The installer calls the [**RmRegisterResources**](/windows/desktop/api/RestartManager/nf-restartmanager-rmregisterresources) function to register resources.</span></span> <span data-ttu-id="8ffb5-110">重新開機管理員只能使用已註冊的資源來判斷哪些應用程式和服務必須關閉並重新啟動。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-110">The Restart Manager can only use registered resources to determine which applications and services must be shut down and restarted.</span></span> <span data-ttu-id="8ffb5-111">所有可能受安裝影響的資源都應該向會話註冊。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-111">All resources that can be affected by the installation should be registered with the session.</span></span> <span data-ttu-id="8ffb5-112">您可以依檔案名、服務簡短名稱或 [**RM 的 \_ 唯一 \_ 進程**](/windows/desktop/api/RestartManager/ns-restartmanager-rm_unique_process) 結構來識別資源。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-112">Resources can be identified by filename, service short name, or an [**RM\_UNIQUE\_PROCESS**](/windows/desktop/api/RestartManager/ns-restartmanager-rm_unique_process) structure.</span></span>
3.  <span data-ttu-id="8ffb5-113">安裝程式會呼叫 [**RmGetList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetlist) 函式，以取得 [**RM \_ 進程 \_ 資訊**](/windows/desktop/api/RestartManager/ns-restartmanager-rm_process_info) 結構的陣列，其中列出必須關閉和重新開機的所有應用程式和服務。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-113">The installer calls the [**RmGetList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetlist) function to obtain an array of [**RM\_PROCESS\_INFO**](/windows/desktop/api/RestartManager/ns-restartmanager-rm_process_info) structures that lists all applications and services that must be shut down and restarted.</span></span>

    <span data-ttu-id="8ffb5-114">如果 [**RmGetList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetlist)函數所傳回的 *lpdwRebootReason* 參數值為非零值，則重新開機管理員無法透過關閉應用程式或服務來釋放已註冊的資源。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-114">If the value of the *lpdwRebootReason* parameter that is returned by the [**RmGetList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetlist) function is nonzero, the Restart Manager is unable to free a registered resource by the shutdown of an application or service.</span></span> <span data-ttu-id="8ffb5-115">在此情況下，需要系統關機並重新啟動，才能繼續安裝。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-115">In this case, a system shutdown and restart is required to continue the installation.</span></span> <span data-ttu-id="8ffb5-116">安裝程式應該會提示使用者輸入動作、停止程式或服務，或排程系統關機並重新啟動。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-116">The installer should prompt the user for an action, stop programs or services, or schedule a system shutdown and restart.</span></span>

    <span data-ttu-id="8ffb5-117">如果 [**RmGetList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetlist)函數所傳回之 *lpdwRebootReason* 參數的值為零，則安裝程式應該呼叫 [**RmShutdown**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown)函數。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-117">If the value of the *lpdwRebootReason* parameter that is returned by the [**RmGetList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetlist) function is zero, the installer should call the [**RmShutdown**](/windows/desktop/api/RestartManager/nf-restartmanager-rmshutdown) function.</span></span> <span data-ttu-id="8ffb5-118">這會關閉使用已註冊資源的服務和應用程式。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-118">This shuts down the services and applications that are using registered resources.</span></span> <span data-ttu-id="8ffb5-119">接著，安裝程式應該執行完成安裝所需的系統修改。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-119">The installer should then perform system modifications that are required to complete the installation.</span></span> <span data-ttu-id="8ffb5-120">最後，安裝程式應該呼叫 [**RmRestart**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart) 函式，讓重新開機管理員可以重新開機已關閉的應用程式，並已註冊重新開機。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-120">Finally, the installer should call the [**RmRestart**](/windows/desktop/api/RestartManager/nf-restartmanager-rmrestart) function so that the Restart Manager can restart the applications it has shut down and that have been registered for a restart.</span></span>

4.  <span data-ttu-id="8ffb5-121">安裝程式可以使用 [**RmAddFilter**](/windows/desktop/api/RestartManager/nf-restartmanager-rmaddfilter) 函式，以防止指定的應用程式和服務被重新開機管理員作業關閉或重新開機。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-121">The installer can use the [**RmAddFilter**](/windows/desktop/api/RestartManager/nf-restartmanager-rmaddfilter) function to prevent specified applications and services from being shutdown or restarted by Restart Manager operations.</span></span> <span data-ttu-id="8ffb5-122">[**RmGetFilterList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetfilterlist)函式會傳回要從關機和重新開機進行篩選的應用程式和服務清單。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-122">The [**RmGetFilterList**](/windows/desktop/api/RestartManager/nf-restartmanager-rmgetfilterlist) function returns a list of the applications and services to be filtered from shutdown and restart.</span></span> <span data-ttu-id="8ffb5-123">[**RmRemoveFilter**](/windows/desktop/api/RestartManager/nf-restartmanager-rmremovefilter)函數會移除篩選。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-123">The [**RmRemoveFilter**](/windows/desktop/api/RestartManager/nf-restartmanager-rmremovefilter) function removes a filter.</span></span>
5.  <span data-ttu-id="8ffb5-124">安裝程式會呼叫 [**RmEndSession**](/windows/desktop/api/RestartManager/nf-restartmanager-rmendsession) 函數來關閉重新開機管理員會話。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-124">The installer calls the [**RmEndSession**](/windows/desktop/api/RestartManager/nf-restartmanager-rmendsession) function to close the Restart Manager session.</span></span>

<span data-ttu-id="8ffb5-125">如需示範如何使用主要安裝程式來啟動和使用重新開機管理員會話的範例程式碼片段，然後將次要安裝程式加入至現有的會話，請參閱搭配 [次要安裝程式使用重新開機管理員](using-restart-manager-with-a-secondary-installer.md)。</span><span class="sxs-lookup"><span data-stu-id="8ffb5-125">For an example code snippet that shows starting and using a Restart Manager session by using a primary installer and then joining a secondary installer to the existing session, see [Using Restart Manager with a Secondary Installer](using-restart-manager-with-a-secondary-installer.md).</span></span>

 

 




