---
title: IDirectWriterLock-複合檔案執行
description: IDirectWriterLock 的複合檔案執行提供了一種方法，可讓您以單一寫入器和多個讀取器在直接模式中開啟複合檔案。
ms.assetid: 4b247dae-d937-430a-bdb7-c47fa3c026b6
keywords:
- IDirectWriterLock Strctd Stg.，複合檔案執行
ms.topic: article
ms.date: 05/31/2018
ms.openlocfilehash: 861935a4c373ce03408c0e633e581e56d39623da
ms.sourcegitcommit: 2d531328b6ed82d4ad971a45a5131b430c5866f7
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 09/16/2019
ms.locfileid: "103671835"
---
# <a name="idirectwriterlock---compound-file-implementation"></a><span data-ttu-id="6bfdb-104">IDirectWriterLock-複合檔案執行</span><span class="sxs-lookup"><span data-stu-id="6bfdb-104">IDirectWriterLock - Compound File Implementation</span></span>

<span data-ttu-id="6bfdb-105">[**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock)的複合檔案執行提供了一種方法，可讓您以單一寫入器和多個讀取器在直接模式中開啟複合檔案。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-105">The compound file implementation of [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) provides a way to open a compound file in direct mode with a single writer and multiple readers.</span></span>

<span data-ttu-id="6bfdb-106">您可以使用 STGM direct 旗標，在直接模式中開啟複合檔案 \_ 。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-106">Compound files can be opened in direct mode using the STGM\_DIRECT flag.</span></span> <span data-ttu-id="6bfdb-107">[**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock)介面會將 STGM \_ READWRITE \| STGM \_ 共用 \_ 拒絕寫入旗標設 \_ 為在直接模式中有效，而不需要快照集複本的額外負荷。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-107">The [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) interface sets the STGM\_READWRITE\|STGM\_SHARE\_DENY\_WRITE flag as valid in direct mode without requiring the overhead of a snapshot copy.</span></span>

<span data-ttu-id="6bfdb-108">當複合檔案使用 STGM 交易旗標以交易模式開啟時 \_ ，您也可以有多個讀取器和單一寫入器使用 STGM \_ READWRITE \| STGM \_ 共用 \_ 拒絕 \_ 寫入旗標。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-108">When a compound file is opened in transacted mode using the STGM\_TRANSACTED flag, you can also have multiple readers and a single writer using the STGM\_READWRITE\|STGM\_SHARE\_DENY\_WRITE flag.</span></span> <span data-ttu-id="6bfdb-109">不過，在此情況下，會為讀取器建立檔案的快照集複本。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-109">However, in this case, a snapshot copy of the file is made for the readers.</span></span> <span data-ttu-id="6bfdb-110">暫存複製通常會產生額外負荷。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-110">There is often overhead of a scratch copy.</span></span>

## <a name="when-to-use"></a><span data-ttu-id="6bfdb-111">使用時機</span><span class="sxs-lookup"><span data-stu-id="6bfdb-111">When to Use</span></span>

<span data-ttu-id="6bfdb-112">當您在直接模式中開啟儲存體時，請使用系統提供的 [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) 執行 (STGM \_ DIRECT) 與 STGM \_ READWRITE \| STGM \_ 共用 \_ 拒絕 \_ 寫入旗標。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-112">Use the system-supplied implementation of [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock) when you open a storage in direct mode (STGM\_DIRECT) with the STGM\_READWRITE\|STGM\_SHARE\_DENY\_WRITE flags.</span></span>

<span data-ttu-id="6bfdb-113">若要取得 [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock)的指標，請在 [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage)上呼叫 **QueryInterface** 來取得複合檔案的根儲存物件。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-113">To obtain a pointer to [**IDirectWriterLock**](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock), call **QueryInterface** on [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) to get the root storage object for the compound file.</span></span>

<span data-ttu-id="6bfdb-114">呼叫 [**IDirectWriterLock：： WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) 來取得複合檔案的獨佔寫入權限。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-114">Call [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) to obtain exclusive write access to a compound file.</span></span> <span data-ttu-id="6bfdb-115">呼叫 [**IDirectWriterLock：： ReleaseWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) 以釋放獨佔寫入權限。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-115">Call [**IDirectWriterLock::ReleaseWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) to release exclusive write access.</span></span>

<span data-ttu-id="6bfdb-116">[**IDirectWriterLock：： HaveWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-havewriteaccess) 指出檔案目前是否已鎖定。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-116">[**IDirectWriterLock::HaveWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-havewriteaccess) indicates whether the file is currently locked.</span></span>

## <a name="remarks"></a><span data-ttu-id="6bfdb-117">備註</span><span class="sxs-lookup"><span data-stu-id="6bfdb-117">Remarks</span></span>

<span data-ttu-id="6bfdb-118">單一寫入器、多重讀取器功能的複合檔案實作為以範圍鎖定為基礎。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-118">The compound file implementation of the single-writer, multiple-reader feature is based on range locking.</span></span> <span data-ttu-id="6bfdb-119">寫入器會取得儲存體的獨佔存取權，以在所有目前的讀取器關閉存放裝置之後寫入。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-119">The writer obtains exclusive access to the storage to write after all current readers have closed the storage.</span></span> <span data-ttu-id="6bfdb-120">當寫入器處於作用中狀態時，後續的讀取器無法開啟儲存體。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-120">While the writer is active, subsequent readers cannot open the storage.</span></span> <span data-ttu-id="6bfdb-121">寫入器會呼叫 [**IDirectWriterLock：： WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) 來取得獨佔寫入存取權。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-121">The writer calls [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) to obtain exclusive write access.</span></span> <span data-ttu-id="6bfdb-122">然後，寫入器必須呼叫 [**IDirectWriterLock：： ReleaseWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) 來釋放儲存體。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-122">The writer must then call [**IDirectWriterLock::ReleaseWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-releasewriteaccess) to release the storage.</span></span>

<span data-ttu-id="6bfdb-123">必須先呼叫 [**IDirectWriterLock：： WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) ，才能在這個單一讀取器的多個寫入器模式下撰寫。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-123">The call to [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess) is required before writing in this single-reader, multiple-writer mode.</span></span> <span data-ttu-id="6bfdb-124">嘗試寫入檔案，但不呼叫 **IDirectWriterLock：： WaitForWriteAccess** ，第一個結果是 Stg. \_ E \_ ACCESSDENIED。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-124">Attempts to write to the file without calling **IDirectWriterLock::WaitForWriteAccess** first result in STG\_E\_ACCESSDENIED.</span></span> <span data-ttu-id="6bfdb-125">即使寫入器一開始開啟檔案，而且沒有讀取器目前開啟檔案，也會傳回此錯誤。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-125">This error is returned even if the writer opened the file initially, and no readers currently have the file open.</span></span>

## <a name="marshaling-considerations"></a><span data-ttu-id="6bfdb-126">封送處理考慮</span><span class="sxs-lookup"><span data-stu-id="6bfdb-126">Marshaling Considerations</span></span>

<span data-ttu-id="6bfdb-127">當複合檔案封送處理至同一部電腦上的另一個進程時，通常會使用自訂封送處理。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-127">Custom marshaling is typically used when a compound file is marshaled to another process on the same machine.</span></span> <span data-ttu-id="6bfdb-128">封送處理儲存體時，不會考慮存取權限，而且 [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) 指標會以與原始封送處理常式相同的存取模式和許可權傳遞給新的進程。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-128">When marshaling storages, access rights are not considered, and the [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) pointer is passed to the new process with the same access modes and rights as the original marshaling process.</span></span> <span data-ttu-id="6bfdb-129">如需存取模式的詳細資訊，請參閱 [**STGM 常數**](stgm-constants.md)。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-129">For more information about access modes, see [**STGM Constants**](stgm-constants.md).</span></span> <span data-ttu-id="6bfdb-130">在封送處理期間，不會採取任何鎖定，以確保獨佔寫入存取權。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-130">During marshaling, no locks are taken or verified to ensure exclusive write access.</span></span> <span data-ttu-id="6bfdb-131">在此情況下，不會對單一寫入器、多重讀取器模式中開啟的複合檔案強制執行單一寫入器原則。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-131">In this case, there is no enforcement of the single-writer policy for compound files opened in the single-writer, multiple-reader mode.</span></span> <span data-ttu-id="6bfdb-132">相反地，強制執行是由複合檔案執行在內部處理。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-132">Instead, enforcement is handled internally by the compound file implementation.</span></span>

<span data-ttu-id="6bfdb-133">由於 [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) 指標會在封送處理期間傳遞至另一個進程，因此兩個進程可能會同時存取相同的複合檔案。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-133">Because the [**IStorage**](/windows/desktop/api/Objidl/nn-objidl-istorage) pointer is passed to another process during marshaling, it is possible for two processes to have simultaneous access to the same compound file.</span></span> <span data-ttu-id="6bfdb-134">即使呼叫端可能會呼叫 [**IDirectWriterLock：： WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess)取得儲存體的獨佔寫入存取權，但封送處理的版本也可以同時具有存取權。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-134">Even though a caller may have obtained exclusive write access to the storage by calling [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), the marshaled version can also have access simultaneously.</span></span> <span data-ttu-id="6bfdb-135">當單一寫入器存取檔案時，不會強制關閉已封送處理的版本。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-135">The marshaled versions are not forced to close while the single writer accesses the file.</span></span> <span data-ttu-id="6bfdb-136">在此情況下，複合檔案執行會在內部同步寫入。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-136">In this case, the compound file implementation synchronizes the writes internally.</span></span>

<span data-ttu-id="6bfdb-137">如果單一寫入器藉由呼叫來取得獨佔存取權， [**IDirectWriterLock：： WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess)，封送處理的儲存體也有寫入權限，而且不需要呼叫 **IDirectWriterLock：： WaitForWriteAccess**。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-137">If a single writer obtains exclusive access by calling, [**IDirectWriterLock::WaitForWriteAccess**](/windows/desktop/api/Objidl/nf-objidl-idirectwriterlock-waitforwriteaccess), the marshaled storage also has write access and does not have to call **IDirectWriterLock::WaitForWriteAccess**.</span></span> <span data-ttu-id="6bfdb-138">這兩個處理常式都有寫入權限，而且同步處理是由內部複合檔案執行所控制。</span><span class="sxs-lookup"><span data-stu-id="6bfdb-138">Both processes have write access and synchronization is controlled by the internal compound file implementation.</span></span>

## <a name="related-topics"></a><span data-ttu-id="6bfdb-139">相關主題</span><span class="sxs-lookup"><span data-stu-id="6bfdb-139">Related topics</span></span>

<dl> <dt>

[<span data-ttu-id="6bfdb-140">**IDirectWriterLock**</span><span class="sxs-lookup"><span data-stu-id="6bfdb-140">**IDirectWriterLock**</span></span>](/windows/desktop/api/Objidl/nn-objidl-idirectwriterlock)
</dt> </dl>

 

 




